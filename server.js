import express from "express";
import * as dotenv from "dotenv";
import cors from "cors";
import { Configuration, OpenAIApi } from "openai";
import bodyParser from "body-parser";

// initialize dotenv with configuration
dotenv.config();

const configuration = new Configuration({
  apiKey: process.env.VITE_OPENAI_KEY,
  organization: process.env.VITE_ORGANIZATION_KEY,
});

console.log(configuration);

const openai = new OpenAIApi(configuration);

// initialize Express server
const app = express();
// set up cors middle from frontend
app.use(cors());
// parse json request from frontend to backend
// app.use(express.json());
app.use(bodyParser.json());

// create domain object routes
// Receive data from frontend
app.get('/', async (req, res) => {
  res.status(200).send({
    message: "HELLO from AkhmimGPT",
  })
  // res.status(500).send({
  //   message: "ERROR from AkhmimGPT",
  // })
});

// Create a payload object
app.post("/chat", async (req, res) => {
//   try {
    const { prompt } = req.body;
    // const prompt = req.body.prompt;
    const response = await openai.createCompletion({
      model: "text-davinci-003",
      // prompt: `${prompt}`,
      prompt: prompt,
      temperature: 0,
      max_tokens: 2048,
      top_p: 1,
      n: 1,
      frequency_penalty: 0.5,
      presence_penalty: 0.0,
      // stream: false,
      // logprobs: null,
      // stop: ["\n"],
    });

    // res.status(200).send({
    //   bot: response.data.choices[0].text,
    //   // setOutput(res);
    // });
    res.send(
      response.data.choices[0].text
    );
//   } 
//   catch (error) {
//     console.log(error);
//     res.status(500).send({ error })
//   }
});

// ansure server response to request
const PORT = 5555;
app.listen(PORT, () => console.log(' Server is running on port  http://localhost:5555 ')); 
